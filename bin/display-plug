#!/bin/bash

set -o pipefail

export HOME=/home/ed
export CACHE_FILE=$HOME/.cache/.external-monitor
export DISPLAY=:0.0
export XAUTHORITY=$HOME/.Xauthority

function connect() {
	echo -e "Connect ${1}\n"
	sed -i 's/^[! ]*Xft.dpi\: [0-9]*$/Xft.dpi: 160/g' $HOME/.Xresources
	# sed -i 's/^Xcursor.size\: [0-9]*$/Xcursor.size: 24/g' $HOME/.Xresources
	xrdb -merge $HOME/.Xresources
	xrandr --output $1 --auto --primary --output eDP-1 --off
}

function disconnect() {
	echo -e "Disconnect ${1}\n"
	extra=""
	if [ ! -z "$1" ]; then
		extra="--output $1 --off"
	fi
	sed -i 's/^[! ]*Xft.dpi\: [0-9]*$/Xft.dpi: 128/g' $HOME/.Xresources
	xrdb -merge $HOME/.Xresources
	xrandr --output eDP-1 --mode 1920x1080 --primary $extra
}

main() {
	# list of all different HDMI ports on docking stations etc.
	disp=$(xrandr -q | grep -E '^(DP|HDMI)[1-9\-]*\sconnected' | head -1 | cut -d' ' -f1)
	if [ -z "$disp" ]; then
		disp="$(cat $CACHE_FILE)"
		disconnect $disp
		truncate -s0 $CACHE_FILE
	else
		echo "$disp" > $CACHE_FILE
		connect $disp
	fi
}

# start it forked so the monitor is active
# this is needed because udev activates the monitor
# AFTER this script returns
main &
